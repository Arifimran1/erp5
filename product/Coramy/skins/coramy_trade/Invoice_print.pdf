<?xml version="1.0" encoding="iso-8859-1" ?>
<document filename="report01.pdf"
  tal:define="invoice_line_list python:here.contentValues(filter={'portal_type':'Invoice Line'});
              from_organisation python:here.restrictedTraverse('organisation/27');
              client_invoice python:here.getDefaultValue('destination_section',spec=['Organisation', 'Person']);
              client_delivery python:here.getDefaultValue('destination_section',spec=['Organisation', 'Person']);
              total_price python:here.getDefaultTotalPrice();">
  <title>Invoice</title>
  <author>Nexedi</author>
  <subject>Coramy Invoice Example</subject>
  <content>

    <tal:block tal:repeat="invoice_line invoice_line_list">
      <tal:block tal:define="cell_range_list python:invoice_line.getCellRange(base_id='movement')">

        <table splitbyrow="1" repeatrows="0" repeatcols="0" style="HeadLine">
          <tr>
            <td colwidth="5cm" tal:content="python: invoice_line.getResourceValue().getDescription()">
              1 pi?ce 2unis
            </td>
            <td colwidth="5cm">12345009 858</td>
          </tr>
        </table>

        <table splitbyrow="1" repeatrows="0" repeatcols="0" style="HeadLine2">
          <tr>
            <td colwidth="5cm">80% Polyamide 20% Elasthanne Lycra</td>
            <td colwidth="5cm">61124110</td>
          </tr>
        </table>

        <table  splitbyrow="1" repeatrows="1" repeatcols="0" style="CellTable"
          tal:define="cell_x_range python: list(cell_range_list[1]);
                      cell_y_range python: list(cell_range_list[0])">
          <tal:block tal:define="dummy python: cell_x_range.sort();
                                 dummy python: cell_y_range.sort()"/>
          <tr>
            <td colwidth="0.6cm"> </td>
            <td colwidth="5.4cm"> </td>
            <tal:block tal:repeat="x cell_x_range">
              <td colwidth="1cm" tal:content="python: x.split('/')[-1]"> </td>
            </tal:block>
            <td tal:attributes="colwidth python: '%fcm' % (8.2 - len(cell_x_range))"> </td>
            <td colwidth="1.5cm"></td>
            <td colwidth="1.5cm"></td>
            <td colwidth="2.2cm"> </td>
          </tr>
          <tal:block tal:repeat="y cell_y_range" tal:define="price_list python:[]">
            <tal:block tal:repeat="x cell_x_range">
              <tal:block tal:define="cell python:invoice_line.getCell(y, x, base_id='movement')">
                <tal:block tal:condition="python:cell is not None and cell.getPrice() not in price_list">
                  <tal:block tal:define="dummy python:price_list.append(cell.getPrice())"/>
                </tal:block>
              </tal:block>
            </tal:block>
            <tal:block tal:repeat="price price_list">
              <tal:block tal:define="global quantity python: 0"/>
              <tal:block tal:repeat="x cell_x_range">
                <tal:block tal:define="cell python:invoice_line.getCell(y, x, base_id='movement')">
                  <tal:block tal:condition="python:cell is not None and cell.getPrice() == price">
                    <tal:block tal:define="global quantity python: quantity + cell.getQuantity()"/>
                  </tal:block>
                </tal:block>
              </tal:block>
              <tr>
                <td> </td>
                <td tal:content="python: y"> </td>
                <tal:block tal:repeat="x cell_x_range">
                  <tal:block tal:define="cell python:invoice_line.getCell(y, x, base_id='movement')">
                    <td><tal:block tal:condition="python:cell is not None and cell.getPrice() == price"><span tal:replace="python: '%.0f ' % cell.getQuantity()"/></tal:block></td>
                  </tal:block>
                </tal:block>
                <td> </td>
                <td tal:content="python: '%d' % quantity">413</td>
                <td tal:content="python: '%.2f' % price">6,27</td>
                <td tal:content="python: '%.2f' % (quantity * price)">2 589,51</td>
              </tr>
            </tal:block>
          </tal:block>
        </table>

        <spacer height="5"/>

        <table  splitbyrow="1" repeatrows="1" repeatcols="0" style="TotalLine">
          <tr>
            <td colwidth="12cm"> </td>
            <td colwidth="1.2cm">Total</td>
            <td colwidth="1cm"> </td>
            <td colwidth="1.5cm" tal:content="python:invoice_line.getTotalQuantity() or 0">2 298</td>
            <td colwidth="1.5cm">pi?ces</td>
          </tr>
        </table>

      </tal:block>
    </tal:block>

  </content>
</document>
