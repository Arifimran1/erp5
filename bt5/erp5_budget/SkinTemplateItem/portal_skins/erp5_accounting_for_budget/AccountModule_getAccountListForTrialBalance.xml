<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <tuple>
          <string>Products.PythonScripts.PythonScript</string>
          <string>PythonScript</string>
        </tuple>
        <none/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Python_magic</string> </key>
            <value> <string encoding="base64">O/INCg==</string> </value>
        </item>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>__ac_local_roles__</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string encoding="cdata"><![CDATA[

import math\n
\n
# wether we should or not expand accounts into virtual accounts (payable & receivable with other parties / cash with bank account)\n
expand_accounts = kw.get("expand_accounts", 1)\n
# the gap tree to use\n
gap_root = kw["gap_root"]\n
\n
def gap_sort_func(a, b) :\n
  a_gap = a.getGapId()\n
  b_gap = b.getGapId()\n
  while len(a_gap) < 7 : \n
    a_gap += \'0\'\n
  while len(b_gap) < 7 : \n
    b_gap += \'0\'\n
  if a_gap < b_gap : return -1\n
  if a_gap > b_gap : return 1\n
  return 0\n
\n
def formatValues(dict) : \n
  for k, v in dict.items():\n
    if not(same_type(v, "") or same_type(v, u"")) :\n
      if round(v) == 0.00 : \n
        dict[k] = ""\n
      else :\n
        # FIXME: this part is a copy of Floatfield format_value\n
        value = str(float(v))\n
        value_list = value.split(\'.\')\n
        integer = value_list[0]\n
        i = len(integer)%3\n
        value = integer[:i]\n
        while i != len(integer):\n
          value += \' \' + integer[i:i+3]\n
          i += 3\n
        dict[k] = \'%s.%s\'%(integer, value_list[1])\n
  return dict \n
\n
def expandBankAccountsForAccount(account, **kw) : \n
  tmp_accounts = []\n
  organisations = context.portal_categories.restrictedTraverse(kw[\'transaction_section_category\']).getGroupRelatedValueList(portal_type=\'Organisation\')\n
  orga_and_banks = []\n
  for orga in organisations : \n
     orga_and_banks += [(orga, o.getObject()) for o in orga.searchFolder(portal_type=[\'Bank Account\'])]\n
  for orga, bank in orga_and_banks : \n
    this_tmp_account = {\n
         \'uid\'   : account.getUid(),\n
         \'id\'    : \'%s-%s-%s\'%(account.getGapId(), orga.getTitle().decode(\'utf8\')[:8].upper(), bank.getTitle().decode(\'utf8\')[:8].upper() ), \n
         \'title\' : \'%s (%s / %s)\'%(account.getTitle(), orga.getTitle(), bank.getTitle()), \n
    }\n
    this_tmp_account[\'debit\']  = bank.BankAccount_statSourceDebit( node_uid = [account.getUid()] )\n
    this_tmp_account[\'credit\'] = bank.BankAccount_statSourceCredit( node_uid = [account.getUid()] ) \n
\n
    balance = this_tmp_account[\'debit\'] - this_tmp_account[\'credit\']\n
    this_tmp_account[\'debit_balance\'] = balance > 0 and balance or 0.00\n
    this_tmp_account[\'credit_balance\'] = balance < 0 and - balance or 0.00\n
    if this_tmp_account[\'credit\'] != 0 or this_tmp_account[\'debit\'] != 0 :\n
      tmp_accounts.append(account.asContext(**formatValues(this_tmp_account)))\n
  return tmp_accounts\n
\n
def expandThirdPartiesForAccount(account, **kw) : \n
  tmp_accounts = []\n
  entities = [o.getObject() for o in context.Account_zDistinctSectionList(node_uid = account.getUid())]\n
  for entity in entities : \n
    if entity.getPortalType() == "Organisation" and entity.getGroup() == kw[\'transaction_section_category\'] : \n
       continue # do not display our organisation\n
    this_tmp_account = {\n
         \'uid\' : account.getUid(),\n
         \'id\'    : \'%s-%s\'%(account.getGapId(), entity.getTitle().decode(\'utf8\')[:12].upper()), \n
         \'title\' : \'%s (%s)\'%(account.getTitle(), entity.getTitle()), \n
    }\n
    this_tmp_account[\'debit\'] = entity.Entity_statSourceDebit( node_uid = [account.getUid()] )\n
    this_tmp_account[\'credit\'] = entity.Entity_statSourceCredit( node_uid = [account.getUid()] ) \n
\n
    balance = this_tmp_account[\'debit\'] - this_tmp_account[\'credit\']\n
    this_tmp_account[\'debit_balance\'] = balance > 0 and balance or 0.00\n
    this_tmp_account[\'credit_balance\'] = balance < 0 and - balance or 0.00\n
    if this_tmp_account[\'credit\'] != 0 or this_tmp_account[\'debit\'] != 0 :\n
      tmp_accounts.append(entity.asContext(**formatValues(this_tmp_account)))\n
  return tmp_accounts\n
\n
\n
### FIXME: is this working ? I guess no, as multi-currency is not yet tested\n
try:\n
  currency = kw[\'accounting_transaction_line_currency\']\n
  id = currency.split(\'/\')[-1]\n
except KeyError:\n
  id = \'\'\n
if not id:\n
  id = \'&nbsp;\'\n
kw[\'select_expression\'] = "\'%s\' AS accounting_transaction_line_currency" % id\n
\n
\n
accounts = [ o.getObject() for o in context.portal_catalog(**kw) ]\n
accounts = filter(lambda account: account.getGapId() is not None, accounts )\n
accounts.sort(gap_sort_func)\n
\n
accounts_to_expand_by_third_parties = \\\n
    context.portal_categories.account_type.asset.receivable.getAccountTypeRelatedValueList(\n
         portal_type=\'Account\', strict_membership=1) + \\\n
    context.portal_categories.account_type.liability.payable.getAccountTypeRelatedValueList(\n
         portal_type=\'Account\', strict_membership=1) # we use strict_membership because we do not want VAT\n
\n
accounts_to_expand_by_bank_accounts = \\\n
    context.portal_categories.account_type.asset.cash.getAccountTypeRelatedValueList(portal_type=\'Account\')\n
\n
report_items = []\n
results = []\n
for account in accounts : \n
  if expand_accounts and account in accounts_to_expand_by_third_parties :\n
    # get all organisations with this account, and create a "virtual-Account" for each organisation\n
    virtual_accounts = expandThirdPartiesForAccount(account, **kw)\n
    # then display the aggregate account\n
    item = {\n
       \'title\': account.getTitle(),\n
       \'debit\': account.Resource_zGetInventory_old(node_uid=account.getUid(), \n
                                            omit_input=1,\n
                                            omit_simulation=1,\n
                                            simulation_state = kw[\'transaction_simulation_state\'],\n
                                            section_category = kw[\'transaction_section_category\'],\n
                                            to_date = kw[\'to_date\'],\n
                                            )[0].quantity or 0.00,  \n
\n
       \'credit\': - (account.Resource_zGetInventory_old(node_uid=account.getUid(), \n
                                            omit_output=1,\n
                                            omit_simulation=1,\n
                                            simulation_state = kw[\'transaction_simulation_state\'], \n
                                            section_category = kw[\'transaction_section_category\'],\n
                                            to_date = kw[\'to_date\'],\n
                                            )[0].quantity or 0.00 )}\n
    # provide a clearly different display when it is a summary account (TODO: it should be in itallic ?).\n
    if len(virtual_accounts) :\n
      item[\'id\'] = "   %s **TOTAL**" % account.getGapId()\n
    else : \n
      item[\'id\'] = account.getGapId()\n
    balance = item[\'debit\'] - item[\'credit\']\n
    item[\'debit_balance\'] = balance > 0 and balance or 0.00\n
    item[\'credit_balance\'] = balance < 0 and - balance or 0.00\n
    report_items += virtual_accounts\n
    report_items.append(account.asContext(**formatValues(item)))\n
\n
  elif expand_accounts and account in accounts_to_expand_by_bank_accounts :\n
    virtual_accounts = expandBankAccountsForAccount(account, **kw)\n
    # then display the aggregate account\n
    item = {\n
       \'title\': account.getTitle(),\n
       \'debit\': account.Resource_zGetInventory_old(node_uid=account.getUid(), \n
                                            omit_input=1,\n
                                            omit_simulation=1,\n
                                            simulation_state = kw[\'transaction_simulation_state\'],\n
                                            section_category = kw[\'transaction_section_category\'],\n
                                            to_date = kw[\'to_date\'],\n
                                            )[0].quantity or 0.00,  \n
\n
       \'credit\': - (account.Resource_zGetInventory_old(node_uid=account.getUid(), \n
                                            omit_output=1,\n
                                            omit_simulation=1,\n
                                            simulation_state = kw[\'transaction_simulation_state\'], \n
                                            section_category = kw[\'transaction_section_category\'],\n
                                            to_date = kw[\'to_date\'],\n
                                            )[0].quantity or 0.00 )}\n
    # provide a clearly different display when it is a summary account (TODO: it should be in itallic ?).\n
    if len(virtual_accounts) :\n
      item[\'id\'] = "   %s **TOTAL**" % account.getGapId()\n
    else : \n
      item[\'id\'] = account.getGapId()\n
    balance = item[\'debit\'] - item[\'credit\']\n
    item[\'debit_balance\'] = balance > 0 and balance or 0.00\n
    item[\'credit_balance\'] = balance < 0 and - balance or 0.00\n
    report_items += virtual_accounts\n
    report_items.append(account.asContext(**formatValues(item)))\n
\n
\n
  else : \n
    item = {\n
       \'id\':    account.getGapId(),\n
       \'title\': account.getTitle(),\n
       \'debit\': account.Resource_zGetInventory_old(node_uid=account.getUid(), \n
                                            omit_input=1,\n
                                            omit_simulation=1,\n
                                            simulation_state = kw[\'transaction_simulation_state\'],\n
                                            section_category = kw[\'transaction_section_category\'],\n
                                            to_date = kw[\'to_date\'],\n
                                            )[0].quantity or 0.00,  \n
\n
       \'credit\': - (account.Resource_zGetInventory_old(node_uid=account.getUid(), \n
                                            omit_output=1,\n
                                            omit_simulation=1,\n
                                            simulation_state = kw[\'transaction_simulation_state\'], \n
                                            to_date = kw[\'to_date\'],\n
                                            section_category = kw[\'transaction_section_category\'],\n
                                            )[0].quantity or 0.00 )}\n
    balance = item[\'debit\'] - item[\'credit\']\n
    item[\'debit_balance\'] = balance > 0 and balance or 0.00\n
    item[\'credit_balance\'] = balance < 0 and - balance or 0.00\n
    report_items.append(account.asContext(**formatValues(item)))\n
    \n
return report_items\n


]]></string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_dav_writelocks</string> </key>
            <value>
              <persistent> <string encoding="base64">AAAAAAAAAAI=</string> </persistent>
            </value>
        </item>
        <item>
            <key> <string>_filepath</string> </key>
            <value> <string>Script (Python):/erp5/portal_skins/erp5_accounting_for_budget/AccountModule_getAccountListForTrialBalance</string> </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>selection, **kw</string> </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>1</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>selection</string>
                            <string>kw</string>
                            <string>math</string>
                            <string>_getattr_</string>
                            <string>expand_accounts</string>
                            <string>_getitem_</string>
                            <string>gap_root</string>
                            <string>gap_sort_func</string>
                            <string>formatValues</string>
                            <string>expandBankAccountsForAccount</string>
                            <string>expandThirdPartiesForAccount</string>
                            <string>currency</string>
                            <string>id</string>
                            <string>KeyError</string>
                            <string>_write_</string>
                            <string>append</string>
                            <string>$append0</string>
                            <string>_getiter_</string>
                            <string>_apply_</string>
                            <string>context</string>
                            <string>o</string>
                            <string>accounts</string>
                            <string>filter</string>
                            <string>accounts_to_expand_by_third_parties</string>
                            <string>accounts_to_expand_by_bank_accounts</string>
                            <string>report_items</string>
                            <string>results</string>
                            <string>account</string>
                            <string>virtual_accounts</string>
                            <string>item</string>
                            <string>len</string>
                            <string>balance</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>AccountModule_getAccountListForTrialBalance</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
  <record id="2" aka="AAAAAAAAAAI=">
    <pickle>
      <tuple>
        <tuple>
          <string>Persistence</string>
          <string>PersistentMapping</string>
        </tuple>
        <none/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>_container</string> </key>
            <value>
              <dictionary/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
