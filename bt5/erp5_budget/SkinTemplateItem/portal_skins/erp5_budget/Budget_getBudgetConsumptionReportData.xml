<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <global name="PythonScript" module="Products.PythonScripts.PythonScript"/>
        <tuple/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>_Cacheable__manager_id</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string encoding="cdata"><![CDATA[

from pprint import pformat\n
portal = context.getPortalObject()\n
request= portal.REQUEST\n
\n
from Products.ERP5Type.Utils import cartesianProduct\n
\n
# this report can be called on a budget ...\n
if context.getPortalType() == \'Budget\':\n
  defined_group = \'group\'\n
  if \'group\' in context.getVariationBaseCategoryList():\n
    for category in context.getVariationCategoryList():\n
      if category.startswith(\'group/\'):\n
        defined_group = category\n
  budget_list = (context,)\n
else:\n
  # ... or on the budget module, and in this case, all budgets are used\n
  defined_group = request[\'section_category\']\n
  from_date = request.get(\'from_date\')\n
  at_date = request.get(\'at_date\')\n
  validation_state = request.get(\'validation_state\', [])\n
  \n
  budget_list = portal.portal_catalog.searchResults(\n
                                portal_type=\'Budget\',\n
                                validation_state=validation_state)\n
  if from_date or at_date:\n
    new_budget_list = []\n
    for budget in budget_list:\n
      if from_date and budget.getStartDateRangeMax() < from_date:\n
        continue\n
      if at_date and budget.getStartDateRangeMin() > at_date:\n
        continue\n
      new_budget_list.append(budget)\n
    budget_list = new_budget_list\n
\n
line_list = []\n
\n
def isVisibleCell(cell):\n
  # can this cell be viewed by this user ?\n
  for category in cell.getMembershipCriterionCategoryList():\n
    if category.startswith(\'group/\'):\n
      if not category.startswith(defined_group):\n
        return False\n
  return True\n
\n
\n
for budget in budget_list:\n
  line_list.append(dict(is_budget=True,\n
                        title=budget.getTitle().decode(\'utf8\'),\n
                        resource_title=budget.getResource() and\n
                                 budget.getResourceReference()))\n
  for budget_line in budget.contentValues(sort_on=((\'int_index\', \'asc\'),)):\n
    total_level_1_initial_budget = 0\n
    total_level_1_current_budget = 0\n
    total_level_1_engaged_budget = 0\n
    total_level_1_consumed_budget = 0\n
    total_level_1_available_budget = 0\n
    \n
    level_1_line_list = []\n
    variation_axis_list = []\n
    for possible_axis in budget_line.getVariationBaseCategoryList():\n
      for cell_range in budget_line.getCellRange():\n
        if cell_range and cell_range[0].startswith(possible_axis):\n
          variation_axis_list.append(possible_axis)\n
          break\n
    \n
    if len(variation_axis_list) == 1:\n
      # if there\'s only one dimension, we add a virtual level 2, to keep the\n
      # same structure\n
      level_2_variation_category_list = [budget_line.getResource(base=1)]\n
      level_3_variation_category_list = [x for x in\n
          budget_line.getVariationCategoryList() if\n
          x.startswith(variation_axis_list[0])]\n
    else:\n
      budget_line_vcl = budget_line.getVariationCategoryList()\n
      budget_line_cell_range = budget_line.BudgetLine_asCellRange()\n
      \n
      level_2_variation_category_list = budget_line.getCellRange()[0]\n
      level_3_variation_category_list = budget_line.getCellRange()[1]\n
\n
    # we use BudgetLine_asCellRange to get cell names, and have a default value\n
    # for "virtual level 2"\n
    title = budget_line.getTitle().decode(\'utf8\')\n
    cell_name_dict = {budget_line.getResource(base=1):\n
                          budget_line.getTitle().decode(\'utf8\')}\n
    cell_style_dict = {budget_line.getResource(base=1): \'Level2\'}\n
    cell_depth_dict = {budget_line.getResource(base=1): 0}\n
\n
    min_depth = 100\n
    budget_line_as_cell_range_matrixbox =\\\n
        budget_line.BudgetLine_asCellRange(matrixbox=1)\n
    for cell_range_list in budget_line_as_cell_range_matrixbox:\n
      for category, title in cell_range_list:\n
        if category in level_2_variation_category_list:\n
          min_depth = min((title.count(\'\\xA0\') / 4) or title.count(\'/\'),\n
                          min_depth)\n
\n
    if min_depth == 100:\n
      min_depth = 0\n
\n
    for cell_range_list in budget_line_as_cell_range_matrixbox:\n
      for category, title in cell_range_list:\n
        cell_name_dict[category] = title.decode(\'utf8\').replace(u\'\\xA0\', \'\')\n
        if category in level_2_variation_category_list:\n
          depth = -min_depth + (title.count(\'\\xA0\') / 4) or title.count(\'/\')\n
          cell_depth_dict[category] = depth\n
          if depth == 1:\n
            cell_style_dict[category] = \'Level2.1\'\n
          elif depth == 2:\n
            cell_style_dict[category] = \'Level2.2\'\n
          elif depth == 3:\n
            cell_style_dict[category] = \'Level2.3\'\n
          else:\n
            cell_style_dict[category] = \'Level2\'\n
\n
    # We\'ll only sum level 2 budget cells if they are the shallowest in the\n
    # category tree\n
    higher_depth = min_depth\n
    if cell_depth_dict:\n
      higher_depth = min(cell_depth_dict.values())\n
\n
    for level_2_category in level_2_variation_category_list:\n
\n
      total_level_2_initial_budget = 0\n
      total_level_2_current_budget = 0\n
      total_level_2_engaged_budget = 0\n
      total_level_2_consumed_budget = 0\n
      total_level_2_available_budget = 0\n
      level_2_line_list = [dict(is_level_2=True,\n
                                title=cell_name_dict[level_2_category],\n
                                style=cell_style_dict[level_2_category])]\n
\n
      is_higher_level2 = cell_depth_dict[level_2_category] == higher_depth\n
\n
      for level_3_category in level_3_variation_category_list:\n
        sign = budget_line.BudgetLine_getConsumptionSign()\n
\n
        for cell_key in cartesianProduct(budget_line.BudgetLine_asCellRange()):\n
          cell = budget_line.getCell(*cell_key)\n
          if not isVisibleCell(cell):\n
            continue\n
          if level_2_category in cell.getMembershipCriterionCategoryList() and\\\n
              level_3_category in cell.getMembershipCriterionCategoryList():\n
\n
            initial_budget = cell.getQuantity() * sign\n
            current_budget = cell.getCurrentBalance() * sign\n
            engaged_budget = cell.getEngagedBudget()\n
            if engaged_budget:\n
              # XXX stupid optimisation that may not always be true\n
              consumed_budget = cell.getConsumedBudget()\n
              available_budget = cell.getAvailableBudget()\n
            else:\n
              consumed_budget = 0\n
              available_budget = current_budget\n
            \n
            total_level_2_initial_budget += initial_budget\n
            total_level_2_current_budget += current_budget\n
            total_level_2_engaged_budget += engaged_budget\n
            total_level_2_consumed_budget += consumed_budget\n
            total_level_2_available_budget += available_budget\n
\n
            consumed_ratio = 0\n
            if current_budget:\n
              consumed_ratio = consumed_budget / current_budget\n
            level_2_line_list.append(dict(title=cell_name_dict[level_3_category],\n
                                          is_level_3=True,\n
                                          initial_budget=initial_budget,\n
                                          current_budget=current_budget,\n
                                          engaged_budget=engaged_budget,\n
                                          consumed_budget=consumed_budget,\n
                                          available_budget=available_budget,\n
                                          consumed_ratio=consumed_ratio))\n
\n
      if len(level_2_line_list) > 1:\n
        consumed_ratio = 0\n
        if total_level_2_current_budget:\n
          consumed_ratio = total_level_2_consumed_budget / total_level_2_current_budget\n
        level_1_line_list.append(dict(is_level_2=True,\n
                                      title=cell_name_dict[level_2_category],\n
                                      style=cell_style_dict[level_2_category],\n
                                      initial_budget=total_level_2_initial_budget,\n
                                      current_budget=total_level_2_current_budget,\n
                                      engaged_budget=total_level_2_engaged_budget,\n
                                      consumed_budget=total_level_2_consumed_budget,\n
                                      available_budget=total_level_2_available_budget,\n
                                      consumed_ratio=consumed_ratio))\n
        level_1_line_list.append(level_2_line_list)\n
\n
      if is_higher_level2:\n
        total_level_1_initial_budget += total_level_2_initial_budget\n
        total_level_1_current_budget += total_level_2_current_budget\n
        total_level_1_engaged_budget += total_level_2_engaged_budget\n
        total_level_1_consumed_budget += total_level_2_consumed_budget\n
        total_level_1_available_budget += total_level_2_available_budget\n
\n
    if len(level_1_line_list) > 1:\n
      consumed_ratio = 0\n
      if total_level_1_current_budget:\n
        consumed_ratio = total_level_1_consumed_budget / total_level_1_current_budget\n
      line_list.append(dict(is_level_1=True,\n
                            title=budget_line.getTitle().decode(\'utf8\'),\n
                            initial_budget=total_level_1_initial_budget,\n
                            current_budget=total_level_1_current_budget,\n
                            engaged_budget=total_level_1_engaged_budget,\n
                            consumed_budget=total_level_1_consumed_budget,\n
                            available_budget=total_level_1_available_budget,\n
                            consumed_ratio=consumed_ratio))\n
      line_list.extend(level_1_line_list)\n
     \n
line_count = 0\n
for line in line_list:\n
  if same_type(line, []):\n
    line_count += len(line)\n
  else:\n
    line_count += 1\n
\n
if not REQUEST:\n
  return line_list, line_count\n
\n
from pprint import pformat\n
return pformat(line_list)\n


]]></string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>REQUEST=None</string> </value>
        </item>
        <item>
            <key> <string>_proxy_roles</string> </key>
            <value>
              <tuple>
                <string>Manager</string>
              </tuple>
            </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>1</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>REQUEST</string>
                            <string>pprint</string>
                            <string>pformat</string>
                            <string>_getattr_</string>
                            <string>context</string>
                            <string>portal</string>
                            <string>request</string>
                            <string>Products.ERP5Type.Utils</string>
                            <string>cartesianProduct</string>
                            <string>defined_group</string>
                            <string>_getiter_</string>
                            <string>category</string>
                            <string>budget_list</string>
                            <string>_getitem_</string>
                            <string>from_date</string>
                            <string>at_date</string>
                            <string>validation_state</string>
                            <string>new_budget_list</string>
                            <string>budget</string>
                            <string>line_list</string>
                            <string>isVisibleCell</string>
                            <string>dict</string>
                            <string>True</string>
                            <string>budget_line</string>
                            <string>total_level_1_initial_budget</string>
                            <string>total_level_1_current_budget</string>
                            <string>total_level_1_engaged_budget</string>
                            <string>total_level_1_consumed_budget</string>
                            <string>total_level_1_available_budget</string>
                            <string>level_1_line_list</string>
                            <string>variation_axis_list</string>
                            <string>possible_axis</string>
                            <string>cell_range</string>
                            <string>len</string>
                            <string>level_2_variation_category_list</string>
                            <string>append</string>
                            <string>$append0</string>
                            <string>x</string>
                            <string>level_3_variation_category_list</string>
                            <string>budget_line_vcl</string>
                            <string>budget_line_cell_range</string>
                            <string>title</string>
                            <string>cell_name_dict</string>
                            <string>cell_style_dict</string>
                            <string>cell_depth_dict</string>
                            <string>min_depth</string>
                            <string>budget_line_as_cell_range_matrixbox</string>
                            <string>cell_range_list</string>
                            <string>min</string>
                            <string>_write_</string>
                            <string>depth</string>
                            <string>higher_depth</string>
                            <string>level_2_category</string>
                            <string>total_level_2_initial_budget</string>
                            <string>total_level_2_current_budget</string>
                            <string>total_level_2_engaged_budget</string>
                            <string>total_level_2_consumed_budget</string>
                            <string>total_level_2_available_budget</string>
                            <string>level_2_line_list</string>
                            <string>is_higher_level2</string>
                            <string>level_3_category</string>
                            <string>sign</string>
                            <string>cell_key</string>
                            <string>_apply_</string>
                            <string>cell</string>
                            <string>initial_budget</string>
                            <string>current_budget</string>
                            <string>engaged_budget</string>
                            <string>consumed_budget</string>
                            <string>available_budget</string>
                            <string>_inplacevar_</string>
                            <string>consumed_ratio</string>
                            <string>line_count</string>
                            <string>line</string>
                            <string>same_type</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <tuple>
                <none/>
              </tuple>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>Budget_getBudgetConsumptionReportData</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
