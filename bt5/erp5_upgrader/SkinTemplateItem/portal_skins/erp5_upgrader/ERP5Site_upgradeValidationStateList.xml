<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <global name="PythonScript" module="Products.PythonScripts.PythonScript"/>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string>"""\n
 It is expected that some objects has some state in the after upgrade finish.\n
 This alarm verify and upgrade the objects that were defined in signature.\n
"""\n
portal_templates = context.portal_templates\n
signature = context.ERP5Site_getUpgraderSignature()\n
validation_dict = signature[ \'validation_dict\']\n
release = signature[\'release\']\n
upgrade = int(upgrade)\n
# get list of title of bt5 that are installed.\n
installed_bt5_title_list = [t.getTitle() for t in portal_templates.getInstalledBusinessTemplateList()]\n
\n
# get the list of keys that correspond to a valid business template.\n
upgradable_list = []\n
for k in validation_dict.keys():\n
  if k in installed_bt5_title_list:\n
    upgradable_list.extend(validation_dict[k])\n
\n
message_list = []\n
for definition in upgradable_list:\n
  sub_message_list = []\n
  path, expected_state, action = definition\n
  obj = context.restrictedTraverse(path)\n
  if obj is not None and \\\n
       getattr(obj, \'getValidationState\', None) is not None and \\\n
       obj.getValidationState() == expected_state:\n
\n
    sub_message_list.append("Upgrade is required for Validation Workflow List (%s object is in %s state, action %s.)" %\n
                (path, expected_state, action))\n
    if upgrade == 1:\n
      workflow_method = getattr(obj, action , None)\n
      if workflow_method is not None:\n
        workflow_method()\n
        sub_message_list.append("updated")\n
    message_list.append(\' \'.join(sub_message_list))\n
    \n
return message_list\n
</string> </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>upgrade=0</string> </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>ERP5Site_upgradeValidationStateList</string> </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
