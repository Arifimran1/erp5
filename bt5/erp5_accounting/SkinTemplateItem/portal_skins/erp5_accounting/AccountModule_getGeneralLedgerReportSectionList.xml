<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <tuple>
          <string>Products.PythonScripts.PythonScript</string>
          <string>PythonScript</string>
        </tuple>
        <none/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Python_magic</string> </key>
            <value> <string encoding="base64">O/INCg==</string> </value>
        </item>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>__ac_local_roles__</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string>"""\n
Get the report sections for general ledger\n
"""\n
from Products.ERP5Form.Report import ReportSection\n
request = context.REQUEST\n
\n
at_date = request[\'at_date\']\n
transaction_section_category = request[\'transaction_section_category\']\n
transaction_simulation_state = request[\'transaction_simulation_state\']\n
from_date = request.get(\'from_date\', None)\n
gap = request.get(\'gap\', None)\n
omit_empty_accounts = request.get(\'omit_empty_accounts\', 1)\n
display_categories = request.get(\'display_categories\', 0)\n
\n
# TODO\n
omit_grouping_reference = request.get(\'omit_grouping_reference\', 0)\n
\n
params = {\n
  \'at_date\'                      : at_date,\n
  \'section_category\'             : transaction_section_category,\n
  \'transaction_section_category\' : transaction_section_category,\n
  \'simulation_state\'             : transaction_simulation_state,\n
  \'accounting_transaction_line_currency\' : None,\n
  \'omit_grouping_reference\'      : omit_grouping_reference,\n
  \'from_date_summary\' : 1\n
}\n
\n
preferences = {\n
  \'preferred_accounting_transaction_at_date\'          : at_date,\n
  \'preferred_accounting_transaction_simulation_state\' :\n
                    transaction_simulation_state,\n
  \'preferred_accounting_transaction_section_category\' :\n
                    transaction_section_category,\n
  # XXX put omit_grouping_reference in preferences ?\n
  #\'preferred_accounting_omit_grouping_reference\' : omit_grouping_reference,\n
}\n
\n
if from_date:\n
  params[\'from_date\'] = from_date\n
  preferences[\'preferred_accounting_transaction_from_date\'] = from_date\n
else :\n
  params[\'no_from_date\'] = 1\n
\n
## FIXME: issue in reporting famework in ERP5 ? \n
from Products.ERP5Type.Cache import clearCache\n
clearCache() # for preferences\n
\n
result = []\n
portal = context.portal_url.getPortalObject()\n
\n
account_columns = (\n
  (\'specific_reference\', \'Reference\'),\n
  (\'delivery.start_date\', \'Date\'),\n
  (\'title\', \'Title\'),\n
  (\'translated_portal_type\', \'Type\'),\n
  (\'third_party\', \'Third Party\'),\n
  (\'translated_simulation_state_title\', \'State\'),\n
  (\'debit\', \'Debit\'),\n
  (\'credit\', \'Credit\'),\n
  (\'net_balance\', \'Balance\'),\n
)\n
\n
if gap :\n
  gap_value_list = [ portal.portal_categories.gap.restrictedTraverse(gap) ] +\\\n
               portal.portal_categories.gap.restrictedTraverse(gap)\\\n
                    .Category_getSortedCategoryChildValueList()\n
else :\n
  cat = \'gap/%s\'%context.portal_preferences\\\n
              .getPreferredAccountingTransactionGap()\\\n
              or context.getPortalDefaultGapRoot()\n
\n
  gap_value_list = portal.portal_categories.resolveCategory(cat)\\\n
                .Category_getSortedCategoryChildValueList()\n
\n
# we don\'t want to display accounts that don\'t have any transactions associated,\n
# so we use a cache to see if the account contains transaction or not ( regardless\n
# of from_date )\n
account_inventory_list_cache = {}\n
account_inventory_list_cache_params = params.copy()\n
if account_inventory_list_cache_params.has_key(\'from_date\') :\n
  del account_inventory_list_cache_params[\'from_date\']\n
\n
for c in gap_value_list :\n
  account_list = c.getGapRelatedValueList(portal_type="Account")\n
  strict_account_list = c.getGapRelatedValueList(\n
                          portal_type="Account", strict_membership = 1)\n
  \n
  skip_branch = 1\n
  for account in account_list :\n
    if account.getUid() not in account_inventory_list_cache :\n
      account_inventory_list_cache[account.getUid()] = len(portal.\\\n
          portal_simulation.getInventoryList( omit_simulation = 1,\n
          node_uid = account.getUid(), **account_inventory_list_cache_params))\n
    if account_inventory_list_cache[account.getUid()] != 0 :\n
      skip_branch = 0\n
  \n
  if skip_branch :\n
    continue\n
\n
  if display_categories and \\\n
          len(account_list) and \\\n
          len(strict_account_list) != 1 :\n
    result.append(ReportSection(\n
      path = c.getPhysicalPath(),\n
      title = "%s: %s" % (c.getId(), c.getTitle()),\n
      level = len(c.getPhysicalPath()) - 4,\n
      form_id = None) )\n
\n
  if len(strict_account_list):\n
    for account in strict_account_list:\n
      if account.getAccountTypeId() in (\'payable\', \'receivable\') :\n
        for third_party_brain in context.Account_zDistinctSectionList(\n
                           at_date = at_date,\n
                           simulation_state = transaction_simulation_state ) :\n
          third_party_params = params.copy()\n
          third_party_params[\'mirror_section_uid\'] = third_party_brain.uid\n
          title = "%s: %s (%s)" % ( c.getId(),\n
                                    account.getTitle(),\n
                                    third_party_brain.title )\n
          if len(portal.portal_simulation.getInventoryList(\n
                    mirror_section_uid = third_party_brain.uid,\n
                    node_uid = account.getUid(),\n
                    **account_inventory_list_cache_params )):\n
            result.append(ReportSection(\n
              path = account.getPhysicalPath(),\n
              title = title,\n
              level = 9,\n
              form_id = \'Account_viewAccountingTransactionList\',\n
              selection_name = \'acount_preference_selection\',\n
              selection_params = third_party_params.copy(),\n
              selection_columns = account_columns,\n
              listbox_display_mode = \'FlatListMode\',\n
              selection_sort_order = [(\'delivery.stop_date\', \'ascending\')],\n
              preferences = preferences ))\n
\n
      elif account.getAccountTypeId() in (\'bank\', \'cash\') :\n
        # Bank Account\n
        for bank_account_brain in account.Account_zGetDistinctPaymentList(\n
                          at_date = at_date,\n
                          simulation_state = transaction_simulation_state ) :\n
          bank_params = params.copy()\n
          if bank_account_brain.path is not None :\n
            bank_params[\'payment_uid\'] = bank_account_brain.uid\n
            title = "%s: %s (%s)" % ( c.getId(),\n
                                      account.getTitle(),\n
                                      bank_account_brain.title )\n
          else :\n
            bank_params[\'no_payment_uid\'] = 1\n
            title = "%s: %s" % ( c.getId(), account.getTitle())\n
          \n
          if len(portal.portal_simulation.getInventoryList(\n
                    payment_uid = bank_account_brain.uid,\n
                    node_uid = account.getUid(),\n
                    **account_inventory_list_cache_params )):\n
            result.append(ReportSection(\n
                path = account.getPhysicalPath(),\n
                title = title,\n
                level = 9,\n
                form_id = \'Account_viewAccountingTransactionList\',\n
                selection_name = \'acount_preference_selection\',\n
                selection_params = bank_params.copy(),\n
                selection_columns = account_columns,\n
                listbox_display_mode = \'FlatListMode\',\n
                selection_sort_order = [(\'delivery.stop_date\', \'ascending\')],\n
                preferences = preferences ))\n
      \n
      else :\n
        if len(portal.portal_simulation.getInventoryList(\n
                    node_uid = account.getUid(),\n
                    **account_inventory_list_cache_params )):\n
          result.append(ReportSection(\n
            path = account.getPhysicalPath(),\n
            title = "%s: %s" % (c.getId(), account.getTitle()),\n
            level = 9,\n
            form_id = \'Account_viewAccountingTransactionList\',\n
            selection_name = \'acount_preference_selection\',\n
            selection_params = params,\n
            selection_columns = account_columns,\n
            listbox_display_mode = \'FlatListMode\',\n
            selection_sort_order = [(\'delivery.stop_date\', \'ascending\')],\n
            preferences = preferences ))\n
\n
return result\n
# vim: syntax=python\n
</string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_dav_writelocks</string> </key>
            <value>
              <persistent> <string encoding="base64">AAAAAAAAAAI=</string> </persistent>
            </value>
        </item>
        <item>
            <key> <string>_filepath</string> </key>
            <value> <string>Script (Python):/nexedi/portal_skins/erp5_accounting/AccountModule_getGeneralLedgerReportSectionList</string> </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string></string> </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>0</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>Products.ERP5Form.Report</string>
                            <string>ReportSection</string>
                            <string>_getattr_</string>
                            <string>context</string>
                            <string>request</string>
                            <string>_getitem_</string>
                            <string>at_date</string>
                            <string>transaction_section_category</string>
                            <string>transaction_simulation_state</string>
                            <string>None</string>
                            <string>from_date</string>
                            <string>gap</string>
                            <string>omit_empty_accounts</string>
                            <string>display_categories</string>
                            <string>omit_grouping_reference</string>
                            <string>params</string>
                            <string>preferences</string>
                            <string>_write_</string>
                            <string>Products.ERP5Type.Cache</string>
                            <string>clearCache</string>
                            <string>result</string>
                            <string>portal</string>
                            <string>account_columns</string>
                            <string>gap_value_list</string>
                            <string>cat</string>
                            <string>account_inventory_list_cache</string>
                            <string>account_inventory_list_cache_params</string>
                            <string>_getiter_</string>
                            <string>c</string>
                            <string>account_list</string>
                            <string>strict_account_list</string>
                            <string>skip_branch</string>
                            <string>account</string>
                            <string>len</string>
                            <string>_apply_</string>
                            <string>third_party_brain</string>
                            <string>third_party_params</string>
                            <string>title</string>
                            <string>bank_account_brain</string>
                            <string>bank_params</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>AccountModule_getGeneralLedgerReportSectionList</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
  <record id="2" aka="AAAAAAAAAAI=">
    <pickle>
      <tuple>
        <tuple>
          <string>Persistence</string>
          <string>PersistentMapping</string>
        </tuple>
        <none/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>_container</string> </key>
            <value>
              <dictionary/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
