<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <tuple>
          <string>Products.PythonScripts.PythonScript</string>
          <string>PythonScript</string>
        </tuple>
        <none/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Python_magic</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>__ac_local_roles__</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string encoding="cdata"><![CDATA[

"""\n
The email ingestion script, called by ZMailIn upon reception of an email.\n
Finds out who sent the letter, finds the sender, discovers properties that may\n
be contained in the mail body (using Document_getPropertyListFromMail),\n
then creates and object from every attachment and sends notifications to the\n
sender.\n
\n
If it returns anything, it is bounced back to the sender as an error message. No return\n
value means everything was fine.\n
"""\n
\n
#from Products.ERP5Type.Message import Message\n
# translating doesn\'t make sense since we have no session, so no preferences\n
\n
noSenderInHeaderMsg = "no sender in headers"\n
noSenderMsg = "you are not in user database"\n
manySendersMsg = "very serious error: your address has multiple entries"\n
\n
# get sender from headers\n
fromraw = theMail[\'headers\'][\'from\']\n
\n
senderemail = context.findAddress(fromraw)\n
if senderemail is None:\n
  print noSenderInHeaderMsg\n
  return printed\n
\n
# find sender\n
context.log(senderemail)\n
r = context.portal_catalog(portal_type=\'Email\', url_string=senderemail)\n
if len(r) == 0:\n
  print noSenderMsg\n
  return printed\n
if len(r) > 1:\n
  print manySendersMsg\n
  return printed\n
\n
senderm = r[0]\n
person = senderm.getParent()\n
context.log(script.getId(), \'ok, this address belongs to \' + person.getRelativeUrl())\n
\n
mailprops = context.Document_getPropertyDictFromMail(theMail[\'body\'])\n
context.log(mailprops)\n
\n
# create objects from attachments\n
try:\n
  for fname, data in theMail[\'attachments\'].items():\n
    obj  = context.portal_contributions.newContent(file_name=fname, \n
                                                       data=data, \n
                                                       portal_type=mailprops.get(\'document_type\'), \n
                                                       user_login=person.getReference(),\n
                                                       **mailprops)\n
    gr = person.Person_getPrincipalGroup()\n
    obj.manage_setLocalRoles(person.getReference(), [\'Owner\',])\n
    context.Document_notifyByEmail(address=senderemail, event=\'ingest\', object=obj)\n
except Exception, e:\n
  context.log(e)\n
  raise\n
return\n


]]></string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_filepath</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>theMail</string> </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>1</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>theMail</string>
                            <string>_print_</string>
                            <string>_print</string>
                            <string>noSenderInHeaderMsg</string>
                            <string>noSenderMsg</string>
                            <string>manySendersMsg</string>
                            <string>_getitem_</string>
                            <string>fromraw</string>
                            <string>_getattr_</string>
                            <string>context</string>
                            <string>senderemail</string>
                            <string>None</string>
                            <string>r</string>
                            <string>len</string>
                            <string>senderm</string>
                            <string>person</string>
                            <string>script</string>
                            <string>mailprops</string>
                            <string>_getiter_</string>
                            <string>fname</string>
                            <string>data</string>
                            <string>_apply_</string>
                            <string>obj</string>
                            <string>gr</string>
                            <string>Exception</string>
                            <string>e</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>Document_ingestEmail</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
