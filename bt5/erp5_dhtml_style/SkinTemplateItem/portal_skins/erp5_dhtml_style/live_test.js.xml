<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <global name="File" module="OFS.Image"/>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>_Cacheable__manager_id</string> </key>
            <value> <string>http_cache</string> </value>
        </item>
        <item>
            <key> <string>_EtagSupport__etag</string> </key>
            <value> <string>ts32869305.67</string> </value>
        </item>
        <item>
            <key> <string>__name__</string> </key>
            <value> <string>live_test.js</string> </value>
        </item>
        <item>
            <key> <string>content_type</string> </key>
            <value> <string>application/x-javascript</string> </value>
        </item>
        <item>
            <key> <string>data</string> </key>
            <value> <string encoding="cdata"><![CDATA[

var live_test_js_already_loaded = false;\n
\n
$(document).ready(function(){\n
\n
  if (live_test_js_already_loaded) {\n
    console.error("Live test already loaded");\n
    return;\n
  }\n
  live_test_js_already_loaded = true;\n
\n
\n
  var my_url_run_test = $(document)[0].baseURI + \'runLiveTest\';\n
  var my_url_read_test = $(document)[0].baseURI + \'readTestOutput\';\n
  var paused = false;\n
\n
  if (! $("*[name=\'field_your_test\']").val() ){\n
    // not in proper page no need to continue\n
    return ;\n
  }\n
  var data_textarea = $("*[name=\'field_your_text_output\']");\n
\n
  data_textarea.val("");\n
\n
  //launch unit test\n
  var continue_loop = true;\n
  $.get(my_url_run_test,\n
        {test_list: $("*[name=\'field_your_test\']").val(),\n
         run_only: $("*[name=\'field_your_run_only\']").val(),\n
         debug: $("*[name=\'field_your_debug\']").is(":checked") ? 1 : 0,\n
         verbose: $("*[name=\'field_your_verbose\']").is(":checked") ? 1: 0\n
        },\n
        function(data) {\n
    continue_loop = false;\n
  });\n
  var last_call = false;\n
  var data_size = 0;\n
  get_data = function() {\n
    return $.get(my_url_read_test,\n
                 {position : data_size},\n
                 function(data){\n
      if ( !paused && data.length !== undefined ) {\n
        data_size = data_size + data.length;\n
        data_textarea.val( data_textarea.val() + data);\n
        data_textarea[0].scrollTop = data_textarea[0].scrollHeight;\n
      }\n
      if (continue_loop) {\n
        setTimeout(get_data, 1000);\n
      }\n
      if (!continue_loop) {\n
        if (!last_call) {\n
          last_call = true;\n
          setTimeout(get_data, 1000);\n
        }\n
      }\n
    });\n
  };\n
\n
  // Not perfect, but the timeout should clearly reduce risk of getting empty result\n
  // while the runUnitTest command had no time yet to reset global variable\n
  // on ERP5 side\n
  setTimeout(get_data,2000);\n
\n
  // pause refreshing if user scrolls in the textarea field\n
  // reactivate refreshing when users scrolls back to bottom\n
  data_textarea.scroll(function() {\n
    paused = data_textarea.scrollTop() + data_textarea.height() != data_textarea[0].scrollHeight;\n
  });\n
\n
});

]]></string> </value>
        </item>
        <item>
            <key> <string>precondition</string> </key>
            <value> <string></string> </value>
        </item>
        <item>
            <key> <string>size</string> </key>
            <value> <int>2082</int> </value>
        </item>
        <item>
            <key> <string>title</string> </key>
            <value> <string></string> </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
