<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <tuple>
          <string>Products.PythonScripts.PythonScript</string>
          <string>PythonScript</string>
        </tuple>
        <none/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Python_magic</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>__ac_local_roles__</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string>"""Search a valid opposition and apply it.\n
"""\n
from DateTime import DateTime\n
\n
portal = context.getPortalObject()\n
accounting_module = portal.accounting_module\n
N_ = portal.Base_translateString\n
invoice_line_object = None\n
\n
for line in context.getMovementList(portal_type=\n
    context.getPortalAccountingMovementTypeList()):\n
  account = line.getDestinationValue()\n
  if account is not None and (\n
      account.isMemberOf(\'account_type/liability/payable\') or \n
      account.isMemberOf(\'gap/fr/m9/2\')): # XXX not generic :(\n
    invoice_line_object = line\n
\n
if invoice_line_object is None:\n
 return\n
\n
# Try to find any matching Opposition\n
for opposition in portal.portal_catalog(portal_type=\'Opposition\',\n
       source_section_relative_url=context.getSourceSection(),\n
       validation_state=\'validated\'):\n
  opposition = opposition.getObject()\n
  # oppositions might already have been used in this transaction, so\n
  # don\'t trust blindly the catalog search.\n
  if opposition.getValidationState() != \'validated\':\n
    continue\n
\n
  # ok, if it matches, apply the opposition\n
  if opposition.test(invoice_line_object):\n
    transaction = accounting_module.newContent(\n
                        created_by_builder=1, # XXX disable init script\n
                        title=opposition.getTitle(),\n
                        portal_type=\'Accounting Transaction\',\n
                        start_date=DateTime(),\n
                        resource=context.getResource(),\n
                        causality_value=context,\n
                        source_section=context.getDestinationSection(), )\n
    \n
    already_consumed_amount = opposition.Opposition_getConsumedAmount()\n
    max_prelevable_amount = min(\n
                  (opposition.getQuantity() - already_consumed_amount),\n
                   opposition.getMaximalQuantityPerOperation())\n
\n
    preleved_amount = min( max_prelevable_amount,\n
                       invoice_line_object.getDestinationCredit() )\n
    \n
    transaction.newContent( portal_type=\'Accounting Transaction Line\',\n
                            source=invoice_line_object.getDestination(),\n
                            destination_section=context.getSourceSection(),\n
                            source_debit=preleved_amount )\n
    \n
    transaction.newContent( portal_type=\'Accounting Transaction Line\',\n
                            source=opposition.getDestination(),\n
                            destination_section=\n
                                      opposition.getDestinationSection(),\n
                            source_credit=preleved_amount,\n
                            aggregate_value=opposition )\n
    transaction.confirm()\n
    break\n
\n
if not batch_mode:\n
  return context.REQUEST.RESPONSE.redirect(\n
          \'%s/view?portal_status_message=%s\' % (\n
          transaction.absolute_url(), N_(\'Opposition+Applied\')))\n
</string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_filepath</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_owner</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>batch_mode=1</string> </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>1</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>batch_mode</string>
                            <string>DateTime</string>
                            <string>_getattr_</string>
                            <string>context</string>
                            <string>portal</string>
                            <string>accounting_module</string>
                            <string>N_</string>
                            <string>None</string>
                            <string>invoice_line_object</string>
                            <string>_getiter_</string>
                            <string>line</string>
                            <string>account</string>
                            <string>opposition</string>
                            <string>transaction</string>
                            <string>already_consumed_amount</string>
                            <string>min</string>
                            <string>max_prelevable_amount</string>
                            <string>preleved_amount</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <tuple>
                <int>1</int>
              </tuple>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>PurchaseInvoiceTransaction_searchAndApplyOpposition</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
