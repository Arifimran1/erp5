<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <tuple>
          <string>Products.PythonScripts.PythonScript</string>
          <string>PythonScript</string>
        </tuple>
        <none/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Python_magic</string> </key>
            <value> <string encoding="base64">bfINCg==</string> </value>
        </item>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>__ac_local_roles__</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string encoding="cdata"><![CDATA[

def lowerCase(s):\n
  return s.replace(\' \', \'_\').lower()\n
\n
def upperCase(s):\n
  s = \' \'.join([x.capitalize() for x in lowerCase(s).split(\'_\') if len(x) > 0])\n
  s = \'/\'.join([x[0].upper() + x[1:] for x in s.split(\'/\') if len(x) > 0])\n
  item_list = s.split(\' \')\n
  if len(item_list) > 1:\n
    new_list = []\n
    for item in item_list :\n
      if item in (\'A\', \'Chez\', \'De\', \'Des\', \'En\', \'Et\', \'La\', \'Par\', \'Pour\') :\n
        item = item.lower()\n
      new_list.append(item)\n
    item_list = new_list\n
  return \' \'.join(item_list)\n
\n
def l_clean(line) :\n
  if line.endswith(\'\\n\') :\n
    line = line[:-1]\n
  return line\n
\n
def l_split(line) :\n
  e_list = line.split(\',\')\n
  new_e_list = []\n
  for e in e_list :\n
    if len(e) > 0 :\n
      if e[0] == \'"\' and e[-1] == \'"\' :\n
        e = e[1:-1]\n
      new_e_list.append(e)\n
  return new_e_list\n
\n
def create_category(cat) :\n
\n
  cat_list = lowerCase(cat).split(\'/\')\n
  cat_len = len(cat_list)\n
  \n
  if cat_len == 1 :\n
    # base_category\n
    return context.portal_categories.newContent(portal_type = \'Base Category\',\n
        id = lowerCase(cat_list[0]),\n
        title = upperCase(cat_list[0]))\n
\n
  elif cat_len > 1 :\n
    # sub_category\n
    relative_category = context.portal_categories.getCategoryValue(lowerCase(\'/\'.join(cat_list[:-1])))\n
\n
    if relative_category is None :\n
      relative_category = create_category(lowerCase(\'/\'.join(cat_list[:-1])))\n
\n
    cat = relative_category.get(lowerCase(cat_list[-1]))\n
    if cat is not None :\n
      return cat\n
    else :\n
      return relative_category.newContent(portal_type = \'Category\',\n
          id = lowerCase(cat_list[-1]),\n
          title = upperCase(cat_list[-1]))\n
\n
def generate_vault_dict() :\n
  c_list = context.portal_categories.vault_type.getCategoryChildValueList()\n
  vault_dict = {}\n
  for c in c_list :\n
    code = c.getProperty(\'codification\')\n
    if code is not None :\n
      vault_dict[code]=c.getRelativeUrl()\n
  return vault_dict\n
\n
##########################################\n
request  = context.REQUEST\n
\n
import_type = getattr(request,\'my_import_type\',None) or getattr(request,\'field_my_import_type\',None)\n
line_list = import_file.readlines()\n
\n
line_list = [l_clean(line) for line in line_list]\n
line_list = [l_split(line) for line in line_list]\n
\n
#return \'\\n\'.join([l for l in line_list])\n
\n
\n
if import_type == \'create_category\' :\n
  if context.portal_categories.get(lowerCase(line_list[0][0])) :\n
    context.portal_categories.deleteContent(lowerCase(line_list[0][0]))\n
  for e_list in line_list :\n
    if len(e_list) > 0 :\n
      e = e_list[0]\n
      try :\n
        print \'trying to create %s ...\' % lowerCase(e),\n
        create_category(e)\n
        print \'done\'\n
      except :\n
        print \'Failed\'\n
        return printed\n
\n
\n
elif import_type == \'assign_codification\' :\n
  for e_list in line_list :\n
    if len(e_list) == 2 :\n
      try :\n
        print \'trying to assign to %s ...\' % lowerCase(e_list[0]) ,\n
        category = context.portal_categories.getCategoryValue(lowerCase(e_list[0]))\n
        category.setCodification(e_list[1])\n
        print \'done %s\' % repr(e_list)\n
      except :\n
        print \'Failed\'\n
        return printed\n
\n
\n
elif import_type == \'assign_vault_type\' :\n
  vault_type_dict = generate_vault_dict()\n
  vault_type_list = vault_type_dict.keys()\n
  for e_list in line_list :\n
    if len(e_list) == 2 and e_list[1] in vault_type_list :\n
      category = context.portal_categories.getCategoryValue(lowerCase(e_list[0]))\n
      category.setCategoryList([vault_type_dict[e_list[1]]])\n
      print \'set %s to %s\' % ([vault_type_dict[e_list[1]]], category)\n
\n
elif import_type == \'create_subvaults\' :\n
#Encaisse des Billets Restitues par Tiers a Detruire# seulemnt sur sites disposant de tri tiers\n
#Encaisse des Billets Recus pour Ventilation# seulement sur sites principaux\n
  subvault_dict = {}\n
  for e_list in line_list :\n
    if len(e_list) == 3 :\n
      vault = lowerCase(e_list[0])\n
      subvault = upperCase(e_list[1])\n
      subvault_code = upperCase(e_list[2])\n
      if not subvault_dict.has_key(vault) :\n
        subvault_dict[vault] = []\n
      subvault_dict[vault].append([subvault, subvault_code])\n
      if subvault == \'Encaisse des Devises\' :\n
        for c in context.currency.objectValues() :\n
          if c.getId() != context.Baobab_getPortalReferenceCurrencyID():\n
            subvault_dict[vault].append([\'%s/%s\' % (subvault, c.getTitle()), None])\n
      if subvault == \'Encaisse des Billets Recus pour Ventilation\' :\n
        for c in context.portal_categories.site.agence.principale.objectIds() :\n
          subvault_dict[vault].append([\'%s/%s\' % (subvault, upperCase(c)), None])\n
\n
  vault_type_list = subvault_dict.keys()\n
\n
  for c in context.portal_categories.site.getCategoryChildValueList() :\n
    for vault_type in vault_type_list :\n
      if context.portal_categories.isMemberOf(c, vault_type, strict=1) :\n
        print c.getRelativeUrl(), \'is\', vault_type\n
        for subvault_data in subvault_dict[vault_type] :\n
          subvault_path = subvault_data[0]\n
          subvault_code = subvault_data[1]\n
          if \'Encaisse des Billets Recus pour Ventilation\' in subvault_path or \'Encaisse des Billets Restitues par Tiers a Detruire\' in subvault_path :\n
            if not context.portal_categories.isMemberOf(c, \'site/agence/principale\', strict=0) :\n
              #print \'XXXXXXXX is not principale, not creating\', subvault_path\n
              pass\n
            elif subvault_path.find(\'/\') > 0 and lowerCase(subvault_path).split(\'/\')[1] in c.getRelativeUrl() :\n
              #print \'XXXXXXXX is itself, not creating\', subvault_path\n
              pass\n
            else :\n
              print \'  creating\', subvault_path\n
              new_category_obj = create_category(\'%s/%s\' % (c.getRelativeUrl(), subvault_path))\n
              if subvault_code not in (None, \'\'):\n
                new_category_obj.setCodification(subvault_code)\n
          else :\n
            print \'  creating\', subvault_path\n
            new_category_obj = create_category(\'%s/%s\' % (c.getRelativeUrl(), subvault_path))\n
            if subvault_code not in (None, \'\'):\n
              new_category_obj.setCodification(subvault_code)\n
        print\n
        break\n
    else : print c.getRelativeUrl(), \'not here\'\n
\n
\n
\n
\n
\n
\n
\n
print \'ok\'\n
return printed\n


]]></string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_filepath</string> </key>
            <value> <string>Script (Python):/baobab/portal_skins/erp5_banking_core/ImportCsvToCategories</string> </value>
        </item>
        <item>
            <key> <string>_owner</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>import_file, **kw</string> </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>1</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>import_file</string>
                            <string>kw</string>
                            <string>_print_</string>
                            <string>_print</string>
                            <string>lowerCase</string>
                            <string>upperCase</string>
                            <string>l_clean</string>
                            <string>l_split</string>
                            <string>create_category</string>
                            <string>generate_vault_dict</string>
                            <string>_getattr_</string>
                            <string>context</string>
                            <string>request</string>
                            <string>getattr</string>
                            <string>None</string>
                            <string>import_type</string>
                            <string>line_list</string>
                            <string>append</string>
                            <string>$append0</string>
                            <string>_getiter_</string>
                            <string>line</string>
                            <string>_getitem_</string>
                            <string>e_list</string>
                            <string>len</string>
                            <string>e</string>
                            <string>category</string>
                            <string>repr</string>
                            <string>vault_type_dict</string>
                            <string>vault_type_list</string>
                            <string>subvault_dict</string>
                            <string>vault</string>
                            <string>subvault</string>
                            <string>subvault_code</string>
                            <string>_write_</string>
                            <string>c</string>
                            <string>vault_type</string>
                            <string>subvault_data</string>
                            <string>subvault_path</string>
                            <string>new_category_obj</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>ImportCsvToCategories</string> </value>
        </item>
        <item>
            <key> <string>title</string> </key>
            <value> <string>Move to erp5_core ?</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
