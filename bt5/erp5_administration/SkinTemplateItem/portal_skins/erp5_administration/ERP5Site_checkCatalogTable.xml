<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <global name="PythonScript" module="Products.PythonScripts.PythonScript"/>
        <tuple/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string>"""\n
  Check that catalog tables contain data which is coherent with actual objects.\n
  Due to the number of objects to check, this function creates activites working\n
  on, at maximum, bundle_object_count objects.\n
\n
  bundle_object_count\n
    Maximum number of objects to deal with in one transaction. \n
    An activity is started after each successfull execution which\n
    found bundle_object_count to work on.\n
  bundle_offset\n
    Offset the bundle, to allow walking along the catalog with\n
    bundle_object_count increment.\n
  property_override_method_id\n
    Id of a method that generates a dictionary of reference values\n
    for a particular item in the catalog.\n
  catalog_kw\n
    Extra parameters passed to catalog\n
  retry\n
    \n
"""\n
context.log(\'starting with uid_min\', uid_min)\n
context.log(\'starting with catalog_uid_list\', catalog_uid_list)\n
from DateTime import DateTime\n
from Products.CMFActivity.ActiveResult import ActiveResult\n
active_result = ActiveResult()\n
active_context = context.getPortalObject().person_module\n
result_list = []\n
if catalog_kw is None:\n
  catalog_kw = {}\n
\n
if not catalog_kw.has_key(\'sort_on\'):\n
  catalog_kw[\'sort_on\'] = ((\'uid\',\'ascending\'),)\n
\n
if catalog_uid_list is None:\n
  # No uid list was given: fetch work to do from catalog and spawn activities\n
  first_run = uid_min is None\n
  bundle_object_count = 200\n
  sql_kw = {}\n
  if uid_min is not None:\n
    # Check what is after last check\n
    catalog_kw[\'uid\'] = {\'query\': uid_min, \'range\': \'nlt\'}\n
  catalog_uid_list = [x.uid for x in context.portal_catalog(\n
          limit=bundle_object_count * activity_count, \n
          **catalog_kw)]\n
  context.log(\'sql src\', context.portal_catalog(limit=bundle_object_count * activity_count, src__=1, **catalog_kw))\n
  if len(catalog_uid_list):\n
    # Get the last uid this pass will check, so that next pass will check a batch starting after this uid.\n
    uid_min = max(catalog_uid_list)\n
    # Spawn activities\n
    worker_tag = tag + \'_worker\'\n
    activity_kw = {\n
      \'activity\': \'SQLQueue\',\n
      \'priority\': 4,\n
      \'lonely\': 1,\n
    }\n
    check_kw = {\n
      \'property_override_method_id\': property_override_method_id,\n
      \'active_process\': active_process,\n
      \'activity_count\': activity_count,\n
      \'tag\': tag\n
    }\n
    for activity in xrange(activity_count):\n
      if len(catalog_uid_list) == 0:\n
        result_list.append(\'No more uids to check, stop spawning activities.\')\n
        break\n
      activity_catalog_uid_list, catalog_uid_list = catalog_uid_list[:bundle_object_count], catalog_uid_list[bundle_object_count:]\n
      result_list.append(\'Spawning activity for range %i..%i (len=%i)\' % (activity_catalog_uid_list[0], activity_catalog_uid_list[-1], len(activity_catalog_uid_list)))\n
      active_context.activate(tag=worker_tag, **activity_kw).ERP5Site_checkCatalogTable(catalog_uid_list=activity_catalog_uid_list,\n
        catalog_kw=catalog_kw, **check_kw)\n
    else:\n
      result_list.append(\'Spawning an activity to fetch a new batch starting above uid %i\' % (uid_min, ))\n
      # For loop was not interrupted by a break, which means that all activities got uids to process. Maybe there is another batch of uids to check besides current one. Spawn an activity to process such batch.\n
      active_context.activate(after_tag=worker_tag, tag=tag, **activity_kw).ERP5Site_checkCatalogTable(uid_min=uid_min, \n
        catalog_kw=catalog_kw, **check_kw)\n
  else:\n
    result_list.append(\'Base_zGetAllFromcatalog found no more line to check.\')\n
  active_result.edit(summary=\'Spawning activities\', severity=0, detail=\'\\n\'.join(result_list))\n
  # Spawn an activity to save generated active result only if it\'s not the initial run\n
  if not first_run:\n
    active_context.activate(active_process=active_process, activity=\'SQLQueue\', priority=2, tag=tag).ERP5Site_saveCheckCatalogTableResult(active_result)\n
else:\n
  # Process given uid list\n
  REFERENCE_DATETIME = DateTime()\n
  MARKER = []\n
  retry_uid_list = []\n
  restrictedTraverse = context.getPortalObject().restrictedTraverse\n
  null_value_list = (\'\', None, 0.0, 0) # Values which are all considered equal.\n
  catalog_line_list = context.portal_catalog(uid_list=catalog_uid_list, **catalog_kw)\n
  attribute_id_list = catalog_line_list.names()\n
  context.log(\'attribute_id_list\', attribute_id_list)\n
  #attribute_id_list.remove(\'catalog_path\')\n
  for catalog_line in catalog_line_list:\n
    object_path = catalog_line[\'path\']\n
    if object_path is None:\n
      if retry:\n
        retry_uid_list.append(catalog_line[\'uid\'])\n
      else:\n
        message = \'Object with uid %r has no path in catalog.\' % (catalog_line[\'uid\'], )\n
        result_list.append(message)\n
      continue\n
    elif object_path == "deleted":\n
      continue\n
    try:\n
      actual_object = restrictedTraverse(catalog_line[\'path\'])\n
    except KeyError:\n
      if retry:\n
        retry_uid_list.append(catalog_line[\'uid\'])\n
      else:\n
        message = \'Object with path %r cannot be found in the ZODB.\' % (object_path, )\n
        result_list.append(message)\n
      continue\n
    if exception_portal_type_list is not None and \\\n
        actual_object.getPortalType() in exception_portal_type_list:\n
      continue\n
    # There is already activity changing the state\n
    if actual_object.hasActivity() \\\n
          or (getattr(actual_object, \'getExplanationValue\', None) is not None \\\n
          and actual_object.getExplanationValue().hasActivity()):\n
        continue\n
    if property_override_method_id is None:\n
      reference_dict = {}\n
    else:\n
      reference_dict = getattr(context, property_override_method_id)(instance=actual_object)\n
    for attribute_id in attribute_id_list:\n
      if not reference_dict.has_key(attribute_id):\n
        reference_value = actual_object.getProperty(attribute_id)\n
      else:\n
        reference_value = reference_dict[attribute_id]\n
      catalog_value = catalog_line[attribute_id]\n
      reference_can_be_null_value = False\n
      if same_type(reference_value, tuple()) or same_type(reference_value, list()):\n
        for reference_value_item in reference_value:\n
          # We probably do not need this\n
          if same_type(reference_value, REFERENCE_DATETIME):\n
            reference_value = DateTime("%s Universal" % reference_value.toZone("Universal").ISO())\n
          if reference_value_item in null_value_list:\n
            reference_can_be_null_value = True\n
      else:\n
        if same_type(reference_value, REFERENCE_DATETIME):\n
          reference_value = DateTime("%s Universal" % reference_value.toZone("Universal").ISO())\n
        if reference_value in null_value_list:\n
          reference_can_be_null_value = True\n
      if reference_can_be_null_value and catalog_value in null_value_list:\n
        continue\n
      elif same_type(reference_value, ()):\n
        if catalog_value not in reference_value:\n
          if retry:\n
            retry_uid_list.append(catalog_line[\'uid\'])\n
          else:\n
            message = \'%s.%s has candidate list %s, but catalog contains %s\' % (actual_object.getRelativeUrl(), attribute_id,\n
                                                                                repr(reference_value), repr(catalog_value))\n
            result_list.append(message)\n
      elif reference_value != catalog_value:\n
        if retry:\n
          retry_uid_list.append(catalog_line[\'uid\'])\n
        else:\n
          message = \'%s.%s = %s, but catalog contains %s\' % (actual_object.getRelativeUrl(), attribute_id,\n
                                                             repr(reference_value), repr(catalog_value))\n
          result_list.append(message)\n
\n
  summary_list = []\n
  begin = catalog_uid_list[0]\n
  end = catalog_uid_list[-1]\n
  entry_summary = \'Entries %s..%s\' % (begin, end)\n
  summary_list.append(entry_summary)\n
  severity = len(result_list)\n
  if severity == 0:\n
    summary_list.append(\'Success\')\n
  else:\n
    summary_list.append(\'Failed\')\n
  active_result.edit(summary=\', \'.join(summary_list), severity=severity, detail=\'\\n\'.join(result_list))\n
  active_context.activate(active_process=active_process,\n
            activity=\'SQLQueue\', \n
            priority=2,\n
            tag=tag).ERP5Site_saveCheckCatalogTableResult(active_result)\n
\n
\n
  if len(retry_uid_list):\n
    # Check again document in case of another sql connection commit changes related to it\n
    worker_tag = tag + \'_worker\'\n
    activity_kw = {\n
      \'activity\': \'SQLQueue\',\n
      \'priority\': 4,\n
      \'lonely\': 1,\n
    }\n
    check_kw = {\n
      \'property_override_method_id\': property_override_method_id,\n
      \'active_process\': active_process,\n
      \'activity_count\': activity_count,\n
      \'tag\': tag\n
    }\n
    active_context.activate(tag=worker_tag, **activity_kw).ERP5Site_checkCatalogTable(catalog_uid_list=retry_uid_list, \n
      catalog_kw=catalog_kw, retry=False, **check_kw)\n
  \n
return active_result\n
</string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>bundle_object_count=100, catalog_uid_list=None, property_override_method_id=None, active_process=None, activity_count=1, get_from_catalog=1, initial_activity_count=None, uid_min=None, tag=\'\', catalog_kw=None, retry=True, exception_portal_type_list=None, **kw</string> </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>12</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>bundle_object_count</string>
                            <string>catalog_uid_list</string>
                            <string>property_override_method_id</string>
                            <string>active_process</string>
                            <string>activity_count</string>
                            <string>get_from_catalog</string>
                            <string>initial_activity_count</string>
                            <string>uid_min</string>
                            <string>tag</string>
                            <string>catalog_kw</string>
                            <string>retry</string>
                            <string>exception_portal_type_list</string>
                            <string>kw</string>
                            <string>_getattr_</string>
                            <string>context</string>
                            <string>DateTime</string>
                            <string>Products.CMFActivity.ActiveResult</string>
                            <string>ActiveResult</string>
                            <string>active_result</string>
                            <string>active_context</string>
                            <string>result_list</string>
                            <string>None</string>
                            <string>_write_</string>
                            <string>first_run</string>
                            <string>sql_kw</string>
                            <string>append</string>
                            <string>$append0</string>
                            <string>_getiter_</string>
                            <string>_apply_</string>
                            <string>x</string>
                            <string>len</string>
                            <string>max</string>
                            <string>worker_tag</string>
                            <string>activity_kw</string>
                            <string>check_kw</string>
                            <string>xrange</string>
                            <string>activity</string>
                            <string>_getitem_</string>
                            <string>activity_catalog_uid_list</string>
                            <string>REFERENCE_DATETIME</string>
                            <string>MARKER</string>
                            <string>retry_uid_list</string>
                            <string>restrictedTraverse</string>
                            <string>null_value_list</string>
                            <string>catalog_line_list</string>
                            <string>attribute_id_list</string>
                            <string>catalog_line</string>
                            <string>object_path</string>
                            <string>message</string>
                            <string>actual_object</string>
                            <string>KeyError</string>
                            <string>getattr</string>
                            <string>reference_dict</string>
                            <string>attribute_id</string>
                            <string>reference_value</string>
                            <string>catalog_value</string>
                            <string>False</string>
                            <string>reference_can_be_null_value</string>
                            <string>same_type</string>
                            <string>tuple</string>
                            <string>list</string>
                            <string>reference_value_item</string>
                            <string>True</string>
                            <string>repr</string>
                            <string>summary_list</string>
                            <string>begin</string>
                            <string>end</string>
                            <string>entry_summary</string>
                            <string>severity</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <tuple>
                <int>100</int>
                <none/>
                <none/>
                <none/>
                <int>1</int>
                <int>1</int>
                <none/>
                <none/>
                <string></string>
                <none/>
                <int>1</int>
                <none/>
              </tuple>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>ERP5Site_checkCatalogTable</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
